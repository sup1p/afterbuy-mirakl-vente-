# Модуль src/services

Этот модуль содержит бизнес-логику и сервисы интеграции для платформ Afterbuy и Mirakl, а также утилиты для сопоставления данных и преобразования в формат CSV. Каждый файл отвечает за определенный аспект интеграционного процесса.

# vente_services/

## - afterbuy_api_calls.py
Обрабатывает все взаимодействия с API Afterbuy, включая:
- **Аутентификация:** Получение и управление токенами доступа для запросов к API.
- **Получение данных о продуктах:** Извлечение информации о продуктах, брендах и тканях из Afterbuy.
- **Логика повторных попыток:** Реализует обработку ошибок и повторные попытки при сбоях сети/API.
- **Пример функций:**
  - `async def get_access_token(httpx_client)`: Аутентифицируется и возвращает токен доступа.
  - `async def get_product_data(ean, httpx_client)`: Извлекает данные о продукте по EAN.
  - `async def get_products_by_fabric(afterbuy_fabric_id, httpx_client)`: Получает продукты по ID ткани.

## - agents.py
Управляет AI-агентом и его настройкой:
- **Создание/инициализация агента:** Создает и настраивает AI-агента.
- **Получение агента:** Возвращает агента для повторного использования в разных модулях.
- **Пример функций:**
  - `def get_agent()`: Возвращает созданного агента.
  - `async def create_agent_with_httpx(httpx_client)`: Создает и настраивает AI-агента с использованием HTTP-клиента.

## - mirakl_api_calls.py
Обрабатывает все взаимодействия с API Mirakl, включая:
- **Импорт продуктов:** Загружает данные продуктов (CSV) в Mirakl для импорта.
- **Проверка ошибок:** Извлекает отчеты об ошибках и статусы импорта.
- **Конфигурация платформы:** Получает настройки платформы Mirakl и состояние интеграции.
- **Пример функций:**
  - `async def import_product(csv_content, httpx_client)`: Импортирует продукты в Mirakl.
  - `async def check_offer_import_error(import_parameter, httpx_client)`: Получает отчет об ошибках для конкретного импорта.
  - `async def check_platform_settings(httpx_client)`: Возвращает настройки платформы.

## - mapping.py
Преобразует и нормализует данные продуктов из Afterbuy в формат, совместимый с Mirakl:
- **Сопоставление атрибутов:** Сопоставляет атрибуты Afterbuy с атрибутами Mirakl, используя константы.
- **Обработка изображений:** Проверяет изображения продуктов, изменяет их размер и загружает на FTP.
- **Нормализация категорий:** Обеспечивает корректное сопоставление категорий продуктов.
- **Пример функций:**
  - `async def map_attributes(data, httpx_client)`: Сопоставляет и нормализует данные продуктов для Mirakl.
  - Вспомогательные функции для обработки изображений и атрибутов.

## - mapping_from_file.py
Преобразует данные продуктов из Afterbuy в формат, совместимый с Mirakl, с использованием данных из файлов:
- **Сопоставление атрибутов:** Сопоставляет атрибуты Afterbuy с атрибутами Mirakl, используя константы.
- **Обработка изображений:** Проверяет изображения продуктов, изменяет их размер и загружает на FTP.
- **Нормализация категорий:** Обеспечивает корректное сопоставление категорий продуктов.
- **Пример функций:**
  - `async def map_attributes(data, httpx_client)`: Сопоставляет и нормализует данные продуктов для Mirakl.
  - Вспомогательные функции для обработки изображений и атрибутов.

## - csv_converter.py
Преобразует структуры данных продуктов в формат CSV для импорта в Mirakl:
- **Генерация CSV:** Сериализует сопоставленные данные продуктов в CSV, обеспечивая корректное кодирование и форматирование.
- **Поддержка пакетов:** Обрабатывает как одиночные, так и массовые экспорты продуктов.
- **Пример функций:**
  - `def make_csv(data)`: Преобразует один продукт в CSV.
  - `def make_big_csv(data)`: Преобразует несколько продуктов в один CSV-файл.