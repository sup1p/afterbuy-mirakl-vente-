# XXLmebel API — Обзор Проекта

## Цель

XXLmebel API — это асинхронный бэкенд-сервис на базе FastAPI для автоматизации миграции и синхронизации больших объемов данных о продуктах между платформой Afterbuy и маркетплейсом Mirakl (vente-unique, Lutz). Сервис предоставляет интеграцию, трансформацию данных, генерацию CSV, обработку ошибок, управление пользователями и централизованное логирование.

## Архитектура и Основные Компоненты

- **FastAPI** — основной веб-фреймворк.
- **src/** — исходный код приложения:
  - **main.py** — точка входа, регистрация роутеров, инициализация ресурсов.
  - **models.py** — ORM-модели (например, User).
  - **resources.py** — глобальные объекты (HTTP-клиент, LLM-агент).
  - **core/** — настройки, зависимости, безопасность.
  - **const/** — константы, атрибуты, YAML/JSON/сопоставления для трансформации данных.
  - **routers/** — API роутеры:
    - **vente/** — импорт продуктов, ошибки, настройки Mirakl.
    - **lutz/** — отдельные роутеры для интеграции Lutz.
    - **user_router.py** — аутентификация и управление пользователями.
  - **services/** — бизнес-логика:
    - **vente_services/** — интеграция Afterbuy/Mirakl, сопоставление, генерация CSV.
    - **lutz_services/** — аналогично для Lutz.
  - **schemas/** — Pydantic-схемы для валидации и сериализации данных.
  - **utils/** — утилиты для обработки изображений, атрибутов, HTML, CSV.
- **alembic/** — миграции базы данных.
- **logs/** — конфигурация логирования и файлы логов.

## Основные Процессы

1. **Аутентификация и Управление Пользователями**
  - OAuth2, JWT, роли (администратор/пользователь).
  - Роуты: `/auth/create-user`, `/auth/login`.

2. **Импорт Продуктов**
  - Получение данных из Afterbuy (по EAN, по fabric_id).
  - Сопоставление атрибутов и нормализация для Mirakl/Lutz.
  - Генерация CSV для импорта.
  - Загрузка изображений на FTP, обработка и изменение размеров.
  - Импорт продуктов в Mirakl/Lutz через API.

3. **Обработка Ошибок и Отчетность**
  - Получение статуса импорта, ошибок, неинтегрированных продуктов.
  - Эндпоинты для отчетов и статуса платформы.

4. **Обработка Атрибутов и Констант**
  - Сопоставление, валидация, перевод значений, поддержка нескольких языков.
  - YAML/JSON/py файлы для соответствия атрибутов.

5. **Логирование**
  - Все операции логируются в `logs/logs.log` с ротацией.

## Конфигурация

- Все параметры (ключи, пароли, URL) задаются через `.env` и используются в `core/settings.py`.
- Alembic — для миграций и управления схемой БД.

## Расширяемость

- Модульная структура: легко добавлять новые роутеры, сервисы, утилиты.
- Константы и сопоставления разделены в отдельные файлы для удобства обслуживания.
- Поддержка нескольких маркетплейсов (vente-unique, Lutz).

## Использование

- REST API для всех операций (импорт, ошибки, управление).
- Swagger UI (`/docs`) для интерактивного тестирования.
- Примеры запросов — см. `README.md`.

## Тесты

- Тесты находятся в `tests/unit/` и `tests/integration/`.

## Быстрый Рабочий Процесс

1. Пользователь аутентифицируется.
2. Импортирует продукты (по EAN, списку, по fabric_id).
3. Сервис получает данные из Afterbuy, преобразует, генерирует CSV, обрабатывает изображения.
4. Импортирует продукты в Mirakl/Lutz, возвращает статус и ошибки.
5. Все действия логируются.

## Развертывание
- Требуется Python 3.11+
- Настройка окружения через `.env` и `uv`
- Запуск с помощью `uv run uvicorn src.main:app`

Для деталей по использованию эндпоинтов и настройке см. основной README.md и документацию API.
